{
  "title": "CEA Sensors Dashboard V3",
  "tags": [
    "cea",
    "sensors",
    "timescaledb"
  ],
  "timezone": "browser",
  "schemaVersion": 38,
  "version": 0,
  "refresh": "1s",
  "panels": [
    {
      "id": 1,
      "title": "Averages",
      "type": "table",
      "description": "Average values from Front and Back clusters",
      "gridPos": {
        "h": 9,
        "w": 3,
        "x": 0,
        "y": 0
      },
      "collapsed": false,
      "targets": [
        {
          "datasource": null,
          "rawSql": "WITH latest_f AS (SELECT DISTINCT ON (s.sensor_id) s.name AS sensor_name, m.value, m.time FROM measurement m JOIN sensor s ON m.sensor_id = s.sensor_id WHERE s.name LIKE '%_f' AND s.name NOT LIKE 'secondary_%' AND m.time >= $__timeFrom() AND m.time <= $__timeTo() ORDER BY s.sensor_id, m.time DESC), latest_b AS (SELECT DISTINCT ON (s.sensor_id) s.name AS sensor_name, m.value, m.time FROM measurement m JOIN sensor s ON m.sensor_id = s.sensor_id WHERE s.name LIKE '%_b' AND s.name NOT LIKE 'secondary_%' AND m.time >= $__timeFrom() AND m.time <= $__timeTo() ORDER BY s.sensor_id, m.time DESC), sensor_data AS (SELECT CASE WHEN REPLACE(f.sensor_name, '_f', '') = 'dry_bulb' THEN 'Dry Bulb Avg' WHEN REPLACE(f.sensor_name, '_f', '') = 'wet_bulb' THEN 'Wet Bulb Avg' WHEN REPLACE(f.sensor_name, '_f', '') = 'rh' THEN 'RH Avg' WHEN REPLACE(f.sensor_name, '_f', '') = 'vpd' THEN 'VPD Avg' WHEN REPLACE(f.sensor_name, '_f', '') = 'co2' THEN 'CO2 Avg' WHEN REPLACE(f.sensor_name, '_f', '') = 'pressure' THEN 'Pressure Avg' WHEN REPLACE(f.sensor_name, '_f', '') = 'water_level' THEN 'Water Level Avg' ELSE REPLACE(f.sensor_name, '_f', '') || ' Avg' END AS \"Sensor\", ROUND((f.value + b.value) / 2.0, 2) AS value_num, CASE WHEN REPLACE(f.sensor_name, '_f', '') = 'dry_bulb' THEN '°C' WHEN REPLACE(f.sensor_name, '_f', '') = 'wet_bulb' THEN '°C' WHEN REPLACE(f.sensor_name, '_f', '') = 'rh' THEN '%' WHEN REPLACE(f.sensor_name, '_f', '') = 'vpd' THEN ' kPa' WHEN REPLACE(f.sensor_name, '_f', '') = 'co2' THEN ' ppm' WHEN REPLACE(f.sensor_name, '_f', '') = 'pressure' THEN ' hPa' WHEN REPLACE(f.sensor_name, '_f', '') = 'water_level' THEN ' mm' ELSE '' END AS unit, GREATEST(f.time, b.time) AS time_val, CASE WHEN REPLACE(f.sensor_name, '_f', '') = 'dry_bulb' THEN 1 WHEN REPLACE(f.sensor_name, '_f', '') = 'wet_bulb' THEN 2 WHEN REPLACE(f.sensor_name, '_f', '') = 'rh' THEN 3 WHEN REPLACE(f.sensor_name, '_f', '') = 'vpd' THEN 4 WHEN REPLACE(f.sensor_name, '_f', '') = 'co2' THEN 5 WHEN REPLACE(f.sensor_name, '_f', '') = 'pressure' THEN 6 WHEN REPLACE(f.sensor_name, '_f', '') = 'water_level' THEN 9 ELSE 10 END AS sort_order FROM latest_f f JOIN latest_b b ON REPLACE(f.sensor_name, '_f', '') = REPLACE(b.sensor_name, '_b', '')), combined AS (SELECT \"Sensor\", (value_num::text || unit) AS \"Value\", sort_order FROM sensor_data UNION ALL SELECT 'Last Update' AS \"Sensor\", TO_CHAR(MAX(time_val), 'YYYY/MM/DD HH24:MI:SS') AS \"Value\", 999 AS sort_order FROM sensor_data) SELECT \"Sensor\", \"Value\" FROM combined ORDER BY sort_order, \"Sensor\"",
          "format": "table",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "value": null,
                "color": "green"
              }
            ]
          }
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Sensor"
            },
            "properties": [
              {
                "id": "custom.width",
                "value": 100
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Value"
            },
            "properties": [
              {
                "id": "custom.width",
                "value": 100
              }
            ]
          }
        ]
      },
      "options": {
        "showHeader": true,
        "sortBy": [],
        "cellHeight": "sm",
        "footer": {
          "show": false,
          "reducer": ["sum"],
          "countRows": false
        }
      },
      "transformations": []
    },
    {
      "id": 2,
      "title": "Front Cluster",
      "type": "table",
      "description": "Front cluster sensors (_f)",
      "gridPos": {
        "h": 11,
        "w": 3,
        "x": 0,
        "y": 9
      },
      "collapsed": false,
      "targets": [
        {
          "datasource": null,
          "rawSql": "WITH sensor_data AS (SELECT DISTINCT ON (s.sensor_id) CASE s.name WHEN 'dry_bulb_f' THEN 'Dry Bulb' WHEN 'wet_bulb_f' THEN 'Wet Bulb' WHEN 'rh_f' THEN 'RH' WHEN 'vpd_f' THEN 'VPD' WHEN 'co2_f' THEN 'CO2' WHEN 'pressure_f' THEN 'Pressure' WHEN 'secondary_temp_f' THEN 'Secondary Temp' WHEN 'secondary_rh_f' THEN 'Secondary RH' WHEN 'water_level_f' THEN 'Water Level' ELSE s.name END AS \"Sensor\", m.value AS value_num, CASE WHEN s.name LIKE 'dry_bulb%' OR s.name LIKE 'secondary_temp%' THEN '°C' WHEN s.name LIKE 'wet_bulb%' THEN '°C' WHEN s.name LIKE 'rh%' AND s.name NOT LIKE 'secondary_rh%' THEN '%' WHEN s.name LIKE 'secondary_rh%' THEN '%' WHEN s.name LIKE 'vpd%' THEN ' kPa' WHEN s.name LIKE 'co2%' THEN ' ppm' WHEN s.name LIKE 'pressure%' THEN ' hPa' WHEN s.name LIKE 'water_level%' THEN ' mm' ELSE '' END AS unit, m.time AS time_val, CASE WHEN s.name LIKE 'dry_bulb%' THEN 1 WHEN s.name LIKE 'wet_bulb%' THEN 2 WHEN s.name LIKE 'rh%' AND s.name NOT LIKE 'secondary_rh%' THEN 3 WHEN s.name LIKE 'vpd%' THEN 4 WHEN s.name LIKE 'co2%' THEN 5 WHEN s.name LIKE 'pressure%' THEN 6 WHEN s.name LIKE 'secondary_temp%' THEN 7 WHEN s.name LIKE 'secondary_rh%' THEN 8 WHEN s.name LIKE 'water_level%' THEN 9 ELSE 10 END AS sort_order FROM measurement m JOIN sensor s ON m.sensor_id = s.sensor_id WHERE s.name LIKE '%_f' AND m.time >= $__timeFrom() AND m.time <= $__timeTo() ORDER BY s.sensor_id, m.time DESC), combined AS (SELECT \"Sensor\", (value_num::text || unit) AS \"Value\", sort_order FROM sensor_data UNION ALL SELECT 'Last Update' AS \"Sensor\", TO_CHAR(MAX(time_val), 'YYYY/MM/DD HH24:MI:SS') AS \"Value\", 999 AS sort_order FROM sensor_data) SELECT \"Sensor\", \"Value\" FROM combined ORDER BY sort_order, \"Sensor\"",
          "format": "table",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "value": null,
                "color": "green"
              }
            ]
          }
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Sensor"
            },
            "properties": [
              {
                "id": "custom.width",
                "value": 100
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Value"
            },
            "properties": [
              {
                "id": "custom.width",
                "value": 100
              }
            ]
          }
        ]
      },
      "options": {
        "showHeader": true,
        "sortBy": [],
        "cellHeight": "sm",
        "footer": {
          "show": false,
          "reducer": ["sum"],
          "countRows": false
        }
      },
      "transformations": []
    },
    {
      "id": 3,
      "title": "Back Cluster",
      "type": "table",
      "description": "Back cluster sensors (_b)",
      "gridPos": {
        "h": 11,
        "w": 3,
        "x": 0,
        "y": 20
      },
      "collapsed": false,
      "targets": [
        {
          "datasource": null,
          "rawSql": "WITH sensor_data AS (SELECT CASE s.name WHEN 'dry_bulb_b' THEN 'Dry Bulb' WHEN 'wet_bulb_b' THEN 'Wet Bulb' WHEN 'rh_b' THEN 'RH' WHEN 'vpd_b' THEN 'VPD' WHEN 'co2_b' THEN 'CO2' WHEN 'pressure_b' THEN 'Pressure' WHEN 'secondary_temp_b' THEN 'Secondary Temp' WHEN 'secondary_rh_b' THEN 'Secondary RH' WHEN 'water_level_b' THEN 'Water Level' ELSE s.name END AS \"Sensor\", m.value AS value_num, CASE WHEN s.name LIKE 'dry_bulb%' OR s.name LIKE 'secondary_temp%' THEN '°C' WHEN s.name LIKE 'wet_bulb%' THEN '°C' WHEN s.name LIKE 'rh%' AND s.name NOT LIKE 'secondary_rh%' THEN '%' WHEN s.name LIKE 'secondary_rh%' THEN '%' WHEN s.name LIKE 'vpd%' THEN ' kPa' WHEN s.name LIKE 'co2%' THEN ' ppm' WHEN s.name LIKE 'pressure%' THEN ' hPa' WHEN s.name LIKE 'water_level%' THEN ' mm' ELSE '' END AS unit, m.time AS time_val, CASE WHEN s.name LIKE 'dry_bulb%' THEN 1 WHEN s.name LIKE 'wet_bulb%' THEN 2 WHEN s.name LIKE 'rh%' AND s.name NOT LIKE 'secondary_rh%' THEN 3 WHEN s.name LIKE 'vpd%' THEN 4 WHEN s.name LIKE 'co2%' THEN 5 WHEN s.name LIKE 'pressure%' THEN 6 WHEN s.name LIKE 'secondary_temp%' THEN 7 WHEN s.name LIKE 'secondary_rh%' THEN 8 WHEN s.name LIKE 'water_level%' THEN 9 ELSE 10 END AS sort_order FROM (SELECT sensor_id, MAX(time) as max_time FROM measurement WHERE time >= NOW() - INTERVAL '10 minutes' GROUP BY sensor_id) latest JOIN measurement m ON m.sensor_id = latest.sensor_id AND m.time = latest.max_time JOIN sensor s ON m.sensor_id = s.sensor_id WHERE s.name LIKE '%_b'), combined AS (SELECT \"Sensor\", (value_num::text || unit) AS \"Value\", sort_order FROM sensor_data UNION ALL SELECT 'Last Update' AS \"Sensor\", TO_CHAR(MAX(time_val), 'YYYY/MM/DD HH24:MI:SS') AS \"Value\", 999 AS sort_order FROM sensor_data) SELECT \"Sensor\", \"Value\" FROM combined ORDER BY sort_order, \"Sensor\"",
          "format": "table",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "value": null,
                "color": "green"
              }
            ]
          }
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Sensor"
            },
            "properties": [
              {
                "id": "custom.width",
                "value": 100
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Value"
            },
            "properties": [
              {
                "id": "custom.width",
                "value": 100
              }
            ]
          }
        ]
      },
      "options": {
        "showHeader": true,
        "sortBy": [],
        "cellHeight": "sm",
        "footer": {
          "show": false,
          "reducer": ["sum"],
          "countRows": false
        }
      },
      "transformations": []
    },
    {
      "id": 4,
      "title": "Temperature, RH & VPD - Main Graph",
      "type": "timeseries",
      "gridPos": {
        "h": 24,
        "w": 21,
        "x": 3,
        "y": 0
      },
      "targets": [
        {
          "datasource": null,
          "rawSql": "SELECT time AS \"time\", sensor_name AS metric, value FROM measurement_with_metadata WHERE sensor_name IN ('dry_bulb_f', 'wet_bulb_f', 'rh_f', 'vpd_f', 'dry_bulb_b', 'wet_bulb_b', 'rh_b', 'vpd_b') AND time >= $__timeFrom() AND time <= $__timeTo() ORDER BY time, sensor_name",
          "format": "time_series",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "celsius",
          "decimals": 2
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "dry_bulb_f"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Dry Bulb (°C) - Front"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "wet_bulb_f"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Wet Bulb (°C) - Front"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "rh_f"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "RH (%) - Front"
              },
              {
                "id": "unit",
                "value": "percent"
              },
              {
                "id": "decimals",
                "value": 1
              },
              {
                "id": "custom.axisPlacement",
                "value": "right"
              },
              {
                "id": "custom.axisSoftMax",
                "value": 100
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "vpd_f"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "VPD (kPa) - Front"
              },
              {
                "id": "unit",
                "value": "kpa"
              },
              {
                "id": "decimals",
                "value": 2
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "dry_bulb_b"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Dry Bulb (°C) - Back"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "wet_bulb_b"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Wet Bulb (°C) - Back"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "rh_b"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "RH (%) - Back"
              },
              {
                "id": "unit",
                "value": "percent"
              },
              {
                "id": "decimals",
                "value": 1
              },
              {
                "id": "custom.axisPlacement",
                "value": "right"
              },
              {
                "id": "custom.axisSoftMax",
                "value": 100
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "vpd_b"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "VPD (kPa) - Back"
              },
              {
                "id": "unit",
                "value": "kpa"
              },
              {
                "id": "decimals",
                "value": 2
              }
            ]
          }
        ]
      },
      "options": {
        "legend": {
          "displayMode": "table",
          "placement": "bottom",
          "showLegend": true,
          "calcs": []
        },
        "tooltip": {
          "mode": "multi"
        }
      }
    },
    {
      "id": 5,
      "title": "CO2 & Pressure",
      "type": "timeseries",
      "gridPos": {
        "h": 8,
        "w": 21,
        "x": 3,
        "y": 24
      },
      "targets": [
        {
          "datasource": null,
          "rawSql": "SELECT time AS \"time\", sensor_name AS metric, value FROM measurement_with_metadata WHERE (sensor_name LIKE 'co2_%' OR sensor_name = 'pressure_b') AND time >= $__timeFrom() AND time <= $__timeTo() ORDER BY time, sensor_name",
          "format": "time_series",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "ppm",
          "decimals": 0,
          "custom": {
            "drawStyle": "line",
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "fillOpacity": 0,
            "spanNulls": true,
            "showPoints": "never"
          }
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "pressure_b"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Pressure (hPa)"
              },
              {
                "id": "unit",
                "value": "hpa"
              },
              {
                "id": "decimals",
                "value": 1
              },
              {
                "id": "custom.axisPlacement",
                "value": "right"
              }
            ]
          }
        ]
      },
      "options": {
        "legend": {
          "displayMode": "table",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "mode": "multi"
        }
      }
    },
    {
      "id": 6,
      "title": "Statistics - Main Graph Sensors",
      "type": "table",
      "gridPos": {
        "h": 8,
        "w": 21,
        "x": 3,
        "y": 32
      },
      "targets": [
        {
          "datasource": null,
          "rawSql": "SELECT CASE sensor_name WHEN 'dry_bulb_f' THEN 'Dry Bulb (C) - Front' WHEN 'wet_bulb_f' THEN 'Wet Bulb (C) - Front' WHEN 'rh_f' THEN 'RH (%) - Front' WHEN 'vpd_f' THEN 'VPD (kPa) - Front' WHEN 'dry_bulb_b' THEN 'Dry Bulb (C) - Back' WHEN 'wet_bulb_b' THEN 'Wet Bulb (C) - Back' WHEN 'rh_b' THEN 'RH (%) - Back' WHEN 'vpd_b' THEN 'VPD (kPa) - Back' ELSE sensor_name END AS \\\"Sensor\\\", MIN(value) AS \\\"Min\\\", MAX(value) AS \\\"Max\\\", AVG(value) AS \\\"Average\\\", STDDEV(value) AS \\\"Std Dev\\\" FROM measurement_with_metadata WHERE sensor_name IN ('dry_bulb_f', 'wet_bulb_f', 'rh_f', 'vpd_f', 'dry_bulb_b', 'wet_bulb_b', 'rh_b', 'vpd_b') AND time >= $__timeFrom() AND time <= $__timeTo() GROUP BY sensor_name ORDER BY CASE WHEN sensor_name LIKE 'dry_bulb%' THEN 1 WHEN sensor_name LIKE 'wet_bulb%' THEN 2 WHEN sensor_name LIKE 'rh%' AND sensor_name NOT LIKE 'secondary_rh%' THEN 3 WHEN sensor_name LIKE 'vpd%' THEN 4 ELSE 10 END, sensor_name",
          "format": "table",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "decimals": 2
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Sensor"
            },
            "properties": [
              {
                "id": "custom.width",
                "value": 200
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Min"
            },
            "properties": [
              {
                "id": "decimals",
                "value": 2
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Max"
            },
            "properties": [
              {
                "id": "decimals",
                "value": 2
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Average"
            },
            "properties": [
              {
                "id": "decimals",
                "value": 2
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Std Dev"
            },
            "properties": [
              {
                "id": "decimals",
                "value": 2
              }
            ]
          }
        ]
      },
      "options": {
        "showHeader": true,
        "sortBy": []
      }
    }
  ],
  "time": {
    "from": "now-6h",
    "to": "now"
  },
  "timepicker": {},
  "templating": {
    "list": []
  },
  "annotations": {
    "list": []
  },
  "editable": true,
  "graphTooltip": 0,
  "links": []
}


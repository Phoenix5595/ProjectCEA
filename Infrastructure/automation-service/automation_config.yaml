# Automation Service Configuration
# Copy this file to automation_config.yaml and fill in your device mappings

# Hardware Configuration
hardware:
  i2c_bus: 1              # Raspberry Pi I2C bus (usually 1)
  i2c_address: 0x20       # MCP23017 I2C address (0x20-0x27, check with: i2cdetect -y 1)
  simulation: false        # Set to true for testing without hardware
  
  # DFR0971 Boards Configuration (for light dimming)
  # Each board has 2 channels (0 and 1)
  # I2C addresses can be changed via jumpers on the board
  # Example: With 3 boards, you have 6 channels total (3 boards × 2 channels)
  dfr0971_boards:
    - board_id: 0              # Board identifier (0, 1, 2, etc.)
      i2c_address: 0x58        # Veg Top and Bottom Right Light Board
      name: "Veg Top and Bottom Right Light Board"
      # This board provides channels: 0 and 1
    - board_id: 1
      i2c_address: 0x59        # Apache° and Veg Bottom Left Light Board
      name: "Apache° and Veg Bottom Left Light Board"
      # This board provides channels: 0 and 1
    - board_id: 2
      i2c_address: 0x5A        # Chilled board
      name: "Chilled Light Board" # Optional name
      # This board provides channels: 0 and 1

# Device Configuration
# Map each device to its MCP23017 channel (0-15)
# Each location can have multiple clusters (e.g., "Flower Room" has "main")
devices:
  "Flower Room":
    main:
      # Example: Heater on channel 0
      heater_1:
        channel: 0                    # MCP23017 channel (0-15)
        device_type: "heater"         # Device type for control logic
        pid_enabled: true              # Use PID control (for heaters, CO2)
        pwm_period: 100                # PWM control period in seconds
        interlock_with:                # Devices that must be OFF (or below max_allowed_load) for this to turn ON
          - "exhaust_fan"
        # Optional: interlock_max_allowed_load: 10  # Allow interlocked devices up to 10% load (default: 0% = full interlock)
      
      # Example: Exhaust fan on channel 1
      exhaust_fan:
        channel: 1
        device_type: "fan"
        pid_enabled: false
        interlock_with: []
      
      # Example: Dehumidifier on channel 2
      dehumidifier_1:
        channel: 2
        device_type: "dehumidifier"
        pid_enabled: false
        interlock_with: []
      
      # Example: Grow lights with DFR0971 dimming
      # Each light needs:
      #   - MCP23017 relay channel (for ON/OFF)
      #   - DFR0971 board_id and channel (for dimming 0-100%)
      # 
      # Board 0, Channel 0: First light
      light_1:
        display_name: Chilled Front
        channel: 3                    # MCP23017 relay channel (ON/OFF control)
        device_type: "light"
        pid_enabled: false
        interlock_with: []
        dimming_enabled: true         # Enable dimming control
        dimming_type: "dfr0971"       # Use DFR0971 for dimming
        dimming_board_id: 2           # Board 2: "Chilled Light Board" (0x5A)
        dimming_channel: 0            # Channel 0 on Board 2
        safety_level: 0               # Default intensity on power-up before service restores (0-100%)
      
      # Board 0, Channel 1: Second light (same board, different channel)
      light_2:
        display_name: Apache
        channel: 4                    # MCP23017 relay channel (ON/OFF control)
        device_type: "light"
        pid_enabled: false
        interlock_with: []
        dimming_enabled: true
        dimming_type: "dfr0971"
        dimming_board_id: 1           # Board 1: "Apache° and Veg Bottom Left Light Board" (0x59)
        dimming_channel: 1            # Channel 1 on Board 1
        safety_level: 0               # Default intensity on power-up before service restores (0-100%)
      
      # Board 1, Channel 0: Third light (different board)
      light_3:
        display_name: Chilled Back
        channel: 5                    # MCP23017 relay channel (ON/OFF control)
        device_type: "light"
        pid_enabled: false
        interlock_with: []
        dimming_enabled: true
        dimming_type: "dfr0971"
        dimming_board_id: 2           # Board 2: "Chilled Light Board" (0x5A)
        dimming_channel: 1            # Channel 1 on Board 2
        safety_level: 0               # Default intensity on power-up before service restores (0-100%)
      

      
      # Example: Water pump on channel 4
      #pump_1:
      #  channel: 4
      #  device_type: "pump"
      #  pid_enabled: false
      #  interlock_with: []
      
      # Example: CO2 enrichment on channel 5
      #co2_1:
      #  channel: 5
      #  device_type: "co2"
      #  pid_enabled: true              # CO2 uses PID control
      #  pwm_period: 100                # PWM control period in seconds
      #  interlock_with: []
  
  "Veg Room":
    main:
      # Devices for Veg Room main cluster
      heater_1:
        channel: 8
        device_type: "heater"
        pid_enabled: true
        pwm_period: 100
        interlock_with:
          - "exhaust_fan"
      
      exhaust_fan:
        channel: 9
        device_type: "fan"
        pid_enabled: false
        interlock_with: []

            # Example: Grow lights with DFR0971 dimming
      # Each light needs:
      #   - MCP23017 relay channel (for ON/OFF)
      #   - DFR0971 board_id and channel (for dimming 0-100%)
      # 
      # Board 0, Channel 0: First light
      light_1:
        display_name: Eyefinity Top
        channel: 3                    # MCP23017 relay channel (ON/OFF control)
        device_type: "light"
        pid_enabled: false
        interlock_with: []
        dimming_enabled: true         # Enable dimming control
        dimming_type: "dfr0971"       # Use DFR0971 for dimming
        dimming_board_id: 0           # Board 0: "Veg Top and Bottom Right Light Board" (0x58)
        dimming_channel: 0            # Channel 0 on Board 0 (Veg Top)
        safety_level: 70              # Default intensity on power-up before service restores (0-100%)
      
      light_2:
        display_name: Ridgetop Bottom Right
        channel: 4                    # MCP23017 relay channel (ON/OFF control)
        device_type: "light"
        pid_enabled: false
        interlock_with: []
        dimming_enabled: true
        dimming_type: "dfr0971"
        dimming_board_id: 0           # Board 0: "Veg Top and Bottom Right Light Board" (0x58)
        dimming_channel: 1            # Channel 1 on Board 0 (Bottom Right)
        safety_level: 20               # Default intensity on power-up before service restores (0-100%)
      
      light_3:
        display_name: Ridgetop Bottom Left
        channel: 5                    # MCP23017 relay channel (ON/OFF control)
        device_type: "light"
        pid_enabled: false
        interlock_with: []
        dimming_enabled: true
        dimming_type: "dfr0971"
        dimming_board_id: 1           # Board 1: "Apache° and Veg Bottom Left Light Board" (0x59)
        dimming_channel: 0            # Channel 0 on Board 1 (Bottom Left)
        safety_level: 0               # Default intensity on power-up before service restores (0-100%)
      

# Control Parameters
control:
  # PID Controller Tuning
  # Adjust these values based on your system response
  pid:
    # Heater PID parameters (temperature control)
    heater_kp: 25.0      # Proportional gain (higher = faster response, but may overshoot)
    heater_ki: 0.02      # Integral gain (eliminates steady-state error)
    heater_kd: 0.0       # Derivative gain (reduces overshoot, usually 0 for heaters)
    
    # CO2 PID parameters
    co2_kp: 10.0
    co2_ki: 0.01
    co2_kd: 0.0
    
    # Default PID parameters (used if device-specific not set)
    default_kp: 10.0
    default_ki: 0.01
    default_kd: 0.0
  
  # Safety Limits (emergency shutoff)
  # These are hard limits that will prevent devices from operating
  safety_limits:
    max_temperature: 35.0    # °C - Heater will not turn on above this
    min_temperature: 10.0    # °C - Heater will not turn on below this
    max_humidity: 90.0       # % - Humidifier will not turn on above this
    min_humidity: 30.0       # % - Dehumidifier will not turn on below this
    max_co2: 2000.0         # ppm - CO2 system will not turn on above this
    min_co2: 400.0          # ppm - CO2 system will not turn on below this
  
  # Default Setpoints (target values for automatic control)
  # These can be changed via API, but these are the initial values
  default_setpoints:
    "Flower Room":
      main:
        temperature: 25.0    # °C target temperature
        humidity: 65.0       # % target humidity
        co2: 1200.0         # ppm target CO2
    "Veg Room":
      main:
        temperature: 25.0
        humidity: 68.0
        co2: 1000.0
  
  # Control Loop Settings
  update_interval: 1        # seconds - How often automatic control runs (default: 1 second)
  
  # Last Good Value Hold Period
  # How long to hold last good sensor value before triggering failsafe (seconds)
  last_good_hold_period: 30  # Hold last good value for 30s before failsafe
  
  # Rate Limiting for Node-RED Overrides
  rate_limit:
    node_red_max_per_second: 1  # Max writes per second per setpoint from Node-RED
  
  # PID Parameter Limits (for validation)
  # These limits prevent unsafe PID parameter values
  pid_limits:
    heater:
      kp_min: 0.0
      kp_max: 100.0
      ki_min: 0.0
      ki_max: 1.0
      kd_min: 0.0
      kd_max: 10.0
    co2:
      kp_min: 0.0
      kp_max: 50.0
      ki_min: 0.0
      ki_max: 0.5
      kd_min: 0.0
      kd_max: 5.0

# Interlock Rules (Safety)
# These are global rules that prevent conflicting device states
# Format: When device A is ON, device B must be OFF (or limited to max_allowed_load)
interlocks:
  # Example: When exhaust fan is ON, heater must be OFF
  # (This is also configured per-device with interlock_with, but global rules apply to all)
  - when_device: "exhaust_fan"
    then_device: "heater_1"
    action: "force_off"      # Force heater OFF when exhaust fan turns ON
    # Optional: max_allowed_load: 10  # Allow up to 10% load, block if higher (default: 0% = full interlock)
  
  # Example: Allow partial load on PWM device
  # - when_device: "heater_1"
  #   then_device: "exhaust_fan"
  #   max_allowed_load: 10  # Allow heater up to 10% when exhaust fan is on

# Sensor Mapping (Optional - for reading sensor data)
# Maps your location/cluster to sensor data sources
# The automation service will read from Redis state keys (with TimescaleDB fallback)
sensors:
  "Flower Room":
    main:
      # Sensor names match your existing sensor naming (dry_bulb_f, rh_f, co2_f, etc.)
      # The service will automatically read these from Redis or TimescaleDB
      temperature_sensor: "dry_bulb_f"    # Sensor name for temperature readings
      humidity_sensor: "rh_f"              # Sensor name for humidity readings
      co2_sensor: "co2_f"                 # Sensor name for CO2 readings
      vpd_sensor: "vpd_f"                 # Sensor name for VPD readings (for dehumidifying device control)
  "Veg Room":
    main:
      temperature_sensor: "dry_bulb_v"
      humidity_sensor: "rh_v"
      co2_sensor: "co2_v"
      vpd_sensor: "vpd_v"                 # Sensor name for VPD readings (for dehumidifying device control)

# Notes:
# - Channel numbers are 0-15 (MCP23017 has 16 channels)
# - Each device must have a unique channel within the same location/cluster
# - Device names can be anything (heater_1, main_heater, etc.)
# - device_type determines control behavior:
#   - "heater": PID control for temperature
#   - "co2": PID control for CO2 level
#   - "fan", "dehumidifier", "humidifier": Threshold-based control
#   - "light", "pump", "vent": On/off control (usually scheduled)
# - interlock_with: List of device names in the same location/cluster that must be OFF (or below max_allowed_load)
# - interlock_max_allowed_load: Optional percentage (0-100) allowing partial load on interlocked devices (default: 0% = full interlock)
#   Example: interlock_max_allowed_load: 10 allows interlocked devices up to 10% load
# - pid_enabled: true for devices that need smooth control (heaters, CO2)
# - pwm_period: PWM control period in seconds (default: 100)

